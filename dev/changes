#!/usr/bin/env perl

use strict;
use warnings;

use Venus::Path;
use Venus::Json;
use Venus::Template;

my $file = 'CHANGES';
my $path = Venus::Path->new;
my $json = Venus::Json->new;

my $cpan = q(
{{for releases}}
{{version}} {{date}}

{{for changes}}
- [{{type}}] ({{hash}}) {{name}} {{if link}}({{link}}){{end link}}
{{end changes}}

{{end releases}}
);

my $markdown = q(
{{for releases}}
## Release [{{version}}](https://github.com/cpanery/venus/releases/tag/{{version}})

{{for changes}}
- [{{type}}] {{name}} {{if link}}([{{hash}}]({{link}})){{end link}}
{{end changes}}

{{end releases}}
);

my $template = Venus::Template->new(
  variables => {
    releases => $json->decode($path->child("$file.json")->read),
  },
);

$path->child("$file")->write($template->do(set => $cpan)->render);
$path->child("$file.md")->write($template->do(set => $markdown)->render);
